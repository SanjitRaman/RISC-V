name: C/C++ CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:

    runs-on: self-hosted

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
     
    - name: Retrieve Google Test
      run: cp ~/actions-runner-local/googletest ./googletest

    - name: Build and Run Control Unit
      run: make runtest MODULE=control_unit MODULE.INCLUDE_DIRS="-y design/control_unit/decoders" && make clean

    - name: Build and Run Reg File
      run: make runtest MODULE=reg_file MODULE.INCLUDE_DIRS="" && make clean

    - name: Build and Run ALU
      run: make runtest MODULE=alu MODULE.INCLUDE_DIRS="" && make clean

    - name: Build and Run Sign Extend
      run: make runtest MODULE=sign_extend MODULE.INCLUDE_DIRS="" && make clean

    - name: Build and Run Data Memory Wrapper
      run: make runtest MODULE=data_mem_wrapper MODULE.INCLUDE_DIRS="-y design/data_mem -y design/we_decoder -y design/ld_decoder" && make clean

    - name: Build and Run Top Level Testbench
      run: make runtest RUN=unit GTEST=0
